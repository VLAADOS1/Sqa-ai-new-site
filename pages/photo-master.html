<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="/css/photo-master.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Bitter:ital,wght@0,100..900;1,100..900&family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap" rel="stylesheet" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <title>Saqa.AI - –§–æ—Ç–æ-–º–∞—Å—Ç–µ—Ä—Å–∫–∞—è</title>
</head>

<body>
  <div class="wrapper">
    <main class="main">
      <!------------ Header / –Ω–∞–≤–∏–≥–∞—Ü–∏—è ------------>
      <div class="settings-info">
        <a href="/pages/navigations.html" class="settings-back-btn">
          <div class="settings-back-icon">
            <svg width="7" height="10" viewBox="0 0 7 10" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M5.25006 8.5L1.75006 5L5.25006 1.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
        </a>
        <div class="setting-text-container">
          <h1 class="settings-title anime-item">–§–æ—Ç–æ –º–∞—Å—Ç–µ—Ä—Å–∫–∞—è</h1>
          <p class="settings-text anime-item">
            –í –¥–∞–Ω–Ω–æ–º —Ä–∞–∑–¥–µ–ª–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω —à–∏—Ä–æ–∫–∏–π –≤—ã–±–æ—Ä <br />
            —Ñ–∏–ª—å—Ç—Ä–æ–≤, –≤ –∫–æ—Ç–æ—Ä–æ–º –≤—ã –º–æ–∂–µ—Ç–µ —Å–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ
          </p>
        </div>
      </div>

      <!------------ Image preview & tools ------------>
      <div class="image-preview">
        <div class="my-image">
          <div class="card anime-item">
            <img src="/images/exxxiee2.jpg" alt="" id="original-image" />
            <canvas id="drawing-canvas"></canvas>
          </div>

          <!------------ Tool-switcher ------------>
          <div class="tools anime-item">
            <div class="tools-bg active-tool" id="brush-tool">
              <img src="/images/icons/brush.png" alt="" class="tools-icon" />
            </div>
            <div class="tools-bg" id="eraser-tool">
              <img src="/images/icons/eraser.png" alt="" class="tools-icon" />
            </div>
          </div>
        </div>

        <div class="select-btn-container anime-item">
          <button class="select-btn" id="save-btn">–ì–æ—Ç–æ–≤–æ</button>
        </div>
      </div>
    </main>
  </div>

  <!------------ LOG-HEAVY –°–ö–†–ò–ü–¢ ------------>
  <script>
    /**
     * –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ª–æ–≥-—Ö–µ–ª–ø–µ—Ä.
     * @param {string} step   ‚Äî –∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —à–∞–≥–∞
     * @param {any=}   data   ‚Äî –¥–æ–ø. –¥–∞–Ω–Ω—ã–µ
     */
    function logStep(step, data = null) {
      const ts = new Date().toISOString();
      if (data !== null) {
        console.log(`üì∏ [PHOTO-MASTER] ${ts} ‚Äî ${step}:`, data);
      } else {
        console.log(`üì∏ [PHOTO-MASTER] ${ts} ‚Äî ${step}`);
      }
    }

    /*--------------------------------------------------
     *  DOMContentLoaded ‚Äî –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
     *-------------------------------------------------*/
    document.addEventListener('DOMContentLoaded', () => {
      logStep('DOMContentLoaded event');

      const dataUrl = sessionStorage.getItem('selectedImage');
      logStep('sessionStorage.getItem("selectedImage")', dataUrl);

      const img = document.getElementById('original-image');
      if (dataUrl) {
        img.src = dataUrl;
        logStep('custom image src set', img.src);
      } else {
        logStep('fallback image src (default)', img.src);
      }

      img.onload = () => {
        logStep('img.onload fired', {
          naturalWidth: img.naturalWidth,
          naturalHeight: img.naturalHeight
        });

        const canvas = document.getElementById('drawing-canvas');
        canvas.width  = img.naturalWidth;
        canvas.height = img.naturalHeight;
        canvas.style.width  = img.width  + 'px';
        canvas.style.height = img.height + 'px';

        logStep('canvas sized', {
          canvasWidth: canvas.width,
          canvasHeight: canvas.height,
          styleWidth: canvas.style.width,
          styleHeight: canvas.style.height
        });
      };
    });

    /*--------------------------------------------------
     *  Click ¬´–ì–æ—Ç–æ–≤–æ¬ª ‚Ää‚Äî‚Ää –æ—Å–Ω–æ–≤–Ω–æ–π –ø–∞–π–ø–ª–∞–π–Ω
     *-------------------------------------------------*/
    document.getElementById('save-btn').addEventListener('click', async () => {
      console.group('üñ±Ô∏è  save-btn clicked');

      try {
        logStep('CLICK handler started');

        const img        = document.getElementById('original-image');
        const drawCanvas = document.getElementById('drawing-canvas');

        /*---------- 1. –ì–µ–Ω–µ—Ä–∏–º mask PNG ----------*/
        console.time('makeMask');
        const maskDataUrl = makeMask(
          drawCanvas,
          img.naturalWidth,
          img.naturalHeight,
          false
        );
        console.timeEnd('makeMask');
        logStep('maskDataUrl generated', maskDataUrl?.substring(0, 80) + '‚Ä¶');

        /*---------- 2. –ó–∞–ª–∏–≤–∞–µ–º mask –Ω–∞ —Å–µ—Ä–≤–µ—Ä ----------*/
        console.time('uploadFile(mask)');
        const maskBlob = await (await fetch(maskDataUrl)).blob();
        const maskUrl  = await uploadFile(maskBlob, 'mask.png');
        console.timeEnd('uploadFile(mask)');
        logStep('mask uploaded', maskUrl);

        /*---------- 3. –ß–∏—Ç–∞–µ–º session/local storage ----------*/
        const photoUrl  = sessionStorage.getItem('uploadedPhotoUrl') || null;
        logStep('sessionStorage.uploadedPhotoUrl', photoUrl);

        const rawAction = sessionStorage.getItem('action');
        logStep('sessionStorage.action', rawAction);
        const action    = rawAction && rawAction !== 'null' ? rawAction : null;

        const rawPrompt = sessionStorage.getItem('promptText');
        logStep('sessionStorage.promptText', rawPrompt);
        const prompt    = rawPrompt && rawPrompt !== 'null' ? rawPrompt : null;

        const extra = {};
        const outfitIdx = localStorage.getItem('selectedOutfitIndex');
        logStep('localStorage.selectedOutfitIndex', outfitIdx);
        const gender    = localStorage.getItem('selectedGender');
        logStep('localStorage.selectedGender', gender);

        if (outfitIdx) extra.outfit = Number(outfitIdx);
        if (gender)    extra.gender = gender;

        /*---------- 4. –§–æ—Ä–º–∏—Ä—É–µ–º payload –∏ –≤—ã–∑—ã–≤–∞–µ–º send() ----------*/
        let payloadToSend;

        if (action && prompt) {
          payloadToSend = { ...extra, photo: photoUrl, mask: maskUrl };
          logStep('Branch: action && prompt', { action, prompt, payloadToSend });

          console.time('send(action, {data})');
          send(action, { data: JSON.stringify(payloadToSend) });
          console.timeEnd('send(action, {data})');

        } else if (action && !prompt) {
          payloadToSend = { ...extra, photo: photoUrl, mask: maskUrl };
          logStep('Branch: action && !prompt', { action, payloadToSend });

          console.time('send(action, {‚Ä¶})');
          send(action, { ...extra, photo: photoUrl, mask: maskUrl });
          console.timeEnd('send(action, {‚Ä¶})');

        } else {
          payloadToSend = { ...extra, photo: photoUrl, mask: maskUrl };
          logStep('Branch: !action', { payloadToSend });

          console.time('send(null, {data})');
          send(null, { data: JSON.stringify(payloadToSend) });
          console.timeEnd('send(null, {data})');
        }

        logStep('Send completed OK');

      } catch (err) {
        logStep('‚ùå ERROR in click handler', err);
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–æ—Ç–æ:', err);
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.');
      } finally {
        console.groupEnd();  //üñ±Ô∏è  save-btn clicked
      }
    });
  </script>

  <!------------ –û—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–¥–∫–ª—é—á–∞–µ–º—ã–µ —Å–∫—Ä–∏–ø—Ç—ã (–æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ------------>
  <script src="/js/upload.js"></script>
  <script src="/js/photo-master.js"></script>
  <script src="/js/theme-switcher.js"></script>
  <script src="/js/animation.js"></script>
  <script src="/js/mask-generator.js"></script>
  <script src="/js/webapp.js"></script>
</body>
</html>
